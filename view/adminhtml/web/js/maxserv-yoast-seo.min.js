define(["jquery","uiRegistry","mage/apply/main","domReady!"],function(c,a,b){c.widget("maxServ.yoastSeo",{options:{provider:false},_create:function(){b.apply();this.config=window.yoastBoxConfig;this.source=a.get(this.config.provider);if(this.config.providerElement){this.sourceData=this.source.data[this.config.providerElement]}else{this.sourceData=this.source.data}this.setup()},setup:function(){this.element=c("#yoast-seo-wrapper");this.snippetPreviewElement=c("#yoast-seo-snippet-preview")[0];this.getInputElements();c("#yoast-seo-wrapper").tabs({active:0});this.inputElements=[this.titleInputElement,this.focusKeywordInputElement];this.hideInputElements=[this.urlKeyInputElement,this.metaTitleInputElement,this.metaDescriptionInputElement];if(!this.config.isKeywordsEnabled){this.hideInputElements.push(this.metaKeywordsInputElement)}this.getTemplateElements();this.setupSnippetPreview();this.setupApp();this.updateFieldsets();this.setupEventListeners()},getFocusKeywordFieldIdentifier:function(){return this.config.focusKeywordFieldIdentifier||".yoastBox-focusKeyword"},getRobotsInstructionsIdentifier:function(){return this.config.robotsInstructionsIdentifier||".yoastBox-robotsInstructions"},getFocusKeywordIdentifier:function(){return this.config.focusKeywordIdentifier||".yoastBox-focusKeyword .admin__control-text"},getTitleIdentifier:function(){return this.config.titleIdentifier||".yoastBox-title .admin__control-text"},getUrlKeyIdentifier:function(){return this.config.urlKeyIdentifier||".yoastBox-urlKey .admin__control-text"},getMetaTitleIdentifier:function(){return this.config.metaTitleIdentifier||".yoastBox-metaTitle .admin__control-text"},getMetaDescriptionIdentifier:function(){return this.config.metaDescriptionIdentifier||".yoastBox-metaDescription .admin__control-textarea"},getMetaKeywordsIdentifier:function(){return this.config.metaKeywordsIdentifier||".yoastBox-metaKeywords"},getInputElements:function(){this.titleInputElement=c(this.getTitleIdentifier()).addClass("yoastBox-inputElement");this.urlKeyInputElement=c(this.getUrlKeyIdentifier());this.metaTitleInputElement=c(this.getMetaTitleIdentifier());this.focusKeywordInputElement=c(this.getFocusKeywordIdentifier()).addClass("yoastBox-inputElement");this.metaDescriptionInputElement=c(this.getMetaDescriptionIdentifier());this.metaKeywordsInputElement=c(this.getMetaKeywordsIdentifier())},getTemplateElements:function(){var f=this.config.contentTemplate,g=f.match(/\{\{([\sa-zA-Z0-9\-_\[\]"=]+)}}/g),d,e,h;this.templateElements={};c(g).each(function(j,i){if(i!=="{{images}}"){d=i.replace(/(\{\{|}})/g,"");h=c(d);if(h.length){this.templateElements[i]={type:"inputElement",element:h};if(!h.hasClass("yoastBox-inputElement")){h.addClass("yoastBox-inputElement")}this.inputElements.push(h)}else{e=d.match('"([^"]+)"');if(e[1]&&this.sourceData[e[1]]){this.templateElements[i]={type:"source",element:e[1]}}}}}.bind(this))},setupSnippetPreview:function(){var d=this;d.snippetPreview=new YoastSEO.SnippetPreview({data:{title:d.getTitleValue(),keyword:d.getKeywordValue(),metaDesc:d.getDescriptionValue(),urlPath:d.getIdentifierValue()},callbacks:{saveSnippetData:function(e){d.saveSnippetData(e)}},baseUrl:d.getBaseUrl(),targetElement:d.snippetPreviewElement})},setupApp:function(){var d=this;this.app=new YoastSEO.App({snippetPreview:d.snippetPreview,contentAnalysisActive:true,targets:{output:"yoast-seo-output",contentOutput:"yoast-seo-content-output"},callbacks:{updateSnippetValues:function(){},saveContentScore:d.updateContentScore.bind(d),getData:function(){return{baseUrl:d.getBaseUrl(),title:d.getTitleValue(),metaTitle:d.getTitleValue(),keyword:d.getKeywordValue(),text:d.getContentValue(),meta:d.getDescriptionValue(),metaDesc:d.getDescriptionValue()}}}});d.app.seoAssessorPresenter.overall="seo-overallScore";d.app.contentAssessorPresenter.overall="readability-overallScore";d.app.refresh()},updateFieldsets:function(){c("#yoast-seo-facebook").append(c(".yoastBox-facebook-fieldset"));c("#yoast-seo-twitter").append(c(".yoastBox-twitter-fieldset"));c("#yoast-seo-focus-input-fieldset").append(c(this.getFocusKeywordFieldIdentifier()));console.log(this.getRobotsInstructionsIdentifier());console.log(c(this.getRobotsInstructionsIdentifier()));c("#yoast-seo-settings-fieldset").append(c(this.getRobotsInstructionsIdentifier()));if(this.config.isKeywordsEnabled){c("#yoast-seo-settings-fieldset").append(this.metaKeywordsInputElement)}c(this.hideInputElements).each(function(){var d=c(this);if(d.hasClass("admin__field")){d.hide()}else{c(this).parents(".admin__field").hide()}})},update:function(){c(".seo-focusKeyword").html(this.getKeywordValue());this.app.refresh();this.snippetPreview.setTitle(this.getTitleValue());this.snippetPreview.setUrlPath(this.getIdentifierValue());this.snippetPreview.setMetaDescription(this.getDescriptionValue())},setupEventListeners:function(){c(document).on("click",".fieldset-wrapper-title",this.getTemplateElements.bind(this)).on("change",".yoastBox-inputElement",this.update.bind(this))},saveSnippetData:function(d){this.setTitleValue(d.title);this.setDescriptionValue(d.metaDesc);this.setIdentifierValue(d.urlPath)},getBaseUrl:function(){var d=window.location.origin;if(d.substring(d.length-1,1)!=="/"){d+="/"}return d},getTitleValue:function(){var d=this.metaTitleInputElement.val(),e=this.titleInputElement.val();if(d){return d}else{if(e){return e}}return""},setTitleValue:function(d){this.metaTitleInputElement.val(d).change();return this},getIdentifierValue:function(){return this.urlKeyInputElement.val()},setIdentifierValue:function(d){this.urlKeyInputElement.val(d).change();return this},getKeywordValue:function(){return this.focusKeywordInputElement.val()},setKeywordValue:function(d){this.focusKeywordInputElement.val(d).change();return this},getContentValue:function(){var h=this,f=h.config.contentTemplate,d,e,g;for(d in h.templateElements){e=h.templateElements[d];g="";switch(e.type){case"inputElement":g=h.getElementValue(e.element);break;case"source":g=this.sourceData[e.element];break}f=f.split(d).join(g)}f=f.replace("{{images}}",h.getEntityImages());return f},getEntityImages:function(){var d="";switch(this.config.entityType){case"catalog_product":d=this.getProductImages();break;default:d=this.config.images.join("<br />");break}return d},getProductImages:function(){var d=[];c('[data-role="image"]').each(function(j,f){var e=c(f),i=e.find('[name*="file"]').val(),h=e.find('[name*="label"]').val(),g=e.find('[name*="disabled"]').val();if(g=="0"){d.push('<img src="'+i+'" alt="'+h+'" />')}});return d.join("<br /> ")},getElementValue:function(f){var d=f.prop("tagName").toLowerCase(),e="";switch(d){case"input":case"textarea":e=f.val();break;case"select":f.find("option:selected").each(function(){e+=(e!==""?", ":"")+c(this).text()});break}return e},getDescriptionValue:function(){return this.metaDescriptionInputElement.val()},setDescriptionValue:function(d){this.metaDescriptionInputElement.val(d).change();return this},updateContentScore:function(e,d){d.renderOverallRating()}});return c.maxServ.yoastSeo});
define(["jquery","uiRegistry","domReady!"],function(b,a){b.widget("maxServ.yoastSeo",{options:{provider:false},_create:function(){this.config=window.yoastBoxConfig;this.source=a.get(this.config.provider);if(this.config.providerElement){this.sourceData=this.source.data[this.config.providerElement]}else{this.sourceData=this.source.data}this.setup()},setup:function(){this.element=b("#yoast-seo-wrapper");this.snippetPreviewElement=b("#yoast-seo-snippet-preview")[0];this.getInputElements();b("#yoast-seo-wrapper").tabs({active:0});this.inputElements=[this.titleInputElement,this.focusKeywordInputElement];this.hideInputElements=[this.urlKeyInputElement,this.metaTitleInputElement,this.metaDescriptionInputElement];this.getTemplateElements();this.setupSnippetPreview();this.setupApp();this.updateFieldsets();this.setupEventListeners()},getFocusKeywordFieldIdentifier:function(){return this.config.focusKeywordFieldIdentifier||".yoastBox-focusKeyword"},getFocusKeywordIdentifier:function(){return this.config.focusKeywordIdentifier||".yoastBox-focusKeyword .admin__control-text"},getTitleIdentifier:function(){return this.config.titleIdentifier||".yoastBox-title .admin__control-text"},getUrlKeyIdentifier:function(){return this.config.urlKeyIdentifier||".yoastBox-urlKey .admin__control-text"},getMetaTitleIdentifier:function(){return this.config.metaTitleIdentifier||".yoastBox-metaTitle .admin__control-text"},getMetaDescriptionIdentifier:function(){return this.config.metaDescriptionIdentifier||".yoastBox-metaDescription .admin__control-textarea"},getMetaKeywordsIdentifier:function(){return this.config.metaKeywordsIdentifier||".yoastBox-metaKeywords"},getInputElements:function(){this.titleInputElement=b(this.getTitleIdentifier()).addClass("yoastBox-inputElement");this.urlKeyInputElement=b(this.getUrlKeyIdentifier());this.metaTitleInputElement=b(this.getMetaTitleIdentifier());this.focusKeywordInputElement=b(this.getFocusKeywordIdentifier()).addClass("yoastBox-inputElement");this.metaDescriptionInputElement=b(this.getMetaDescriptionIdentifier())},getTemplateElements:function(){var e=this.config.contentTemplate,f=e.match(/\{\{([\sa-zA-Z0-9\-_\[\]"=]+)}}/g),c,d,g;this.templateElements={};b(f).each(function(i,h){if(h!=="{{images}}"){c=h.replace(/(\{\{|}})/g,"");g=b(c);if(g.length){this.templateElements[h]={type:"inputElement",element:g};if(!g.hasClass("yoastBox-inputElement")){g.addClass("yoastBox-inputElement")}this.inputElements.push(g)}else{d=c.match('"([^"]+)"');if(d[1]&&this.sourceData[d[1]]){this.templateElements[h]={type:"source",element:d[1]}}}}}.bind(this))},setupSnippetPreview:function(){var c=this;c.snippetPreview=new YoastSEO.SnippetPreview({data:{title:c.getTitleValue(),keyword:c.getKeywordValue(),metaDesc:c.getDescriptionValue(),urlPath:c.getIdentifierValue()},callbacks:{saveSnippetData:function(d){c.saveSnippetData(d)}},baseUrl:c.getBaseUrl(),targetElement:c.snippetPreviewElement})},setupApp:function(){var c=this;this.app=new YoastSEO.App({snippetPreview:c.snippetPreview,contentAnalysisActive:true,targets:{output:"yoast-seo-output",contentOutput:"yoast-seo-content-output"},callbacks:{updateSnippetValues:function(){},getData:function(){return{baseUrl:c.getBaseUrl(),title:c.getTitleValue(),metaTitle:c.getTitleValue(),keyword:c.getKeywordValue(),text:c.getContentValue(),meta:c.getDescriptionValue(),metaDesc:c.getDescriptionValue()}}}});c.app.refresh()},updateFieldsets:function(){b("#yoast-seo-facebook").append(b(".yoastBox-facebook-fieldset"));b("#yoast-seo-twitter").append(b(".yoastBox-twitter-fieldset"));b("#yoast-seo-keywords-fieldset").append(b(this.getMetaKeywordsIdentifier()));b("#yoast-seo-focus-input-fieldset").append(b(this.getFocusKeywordFieldIdentifier()));b(this.hideInputElements).each(function(){b(this).parents(".admin__field").hide()})},update:function(){this.app.refresh();this.snippetPreview.setTitle(this.getTitleValue());this.snippetPreview.setUrlPath(this.getIdentifierValue());this.snippetPreview.setMetaDescription(this.getDescriptionValue())},setupEventListeners:function(){b(document).on("click",".fieldset-wrapper-title",this.getTemplateElements.bind(this)).on("change",".yoastBox-inputElement",this.update.bind(this))},saveSnippetData:function(c){this.setTitleValue(c.title);this.setDescriptionValue(c.metaDesc);this.setIdentifierValue(c.urlPath)},getBaseUrl:function(){var c=window.location.origin;if(c.substring(c.length-1,1)!=="/"){c+="/"}return c},getTitleValue:function(){var c=this.metaTitleInputElement.val(),d=this.titleInputElement.val();if(c){return c}else{if(d){return d}}return""},setTitleValue:function(c){this.metaTitleInputElement.val(c).change();return this},getIdentifierValue:function(){return this.urlKeyInputElement.val()},setIdentifierValue:function(c){this.urlKeyInputElement.val(c).change();return this},getKeywordValue:function(){return this.focusKeywordInputElement.val()},setKeywordValue:function(c){this.focusKeywordInputElement.val(c).change();return this},getContentValue:function(){var g=this,e=g.config.contentTemplate,c,d,f;for(c in g.templateElements){d=g.templateElements[c];f="";switch(d.type){case"inputElement":f=g.getElementValue(d.element);break;case"source":f=this.sourceData[d.element];break}e=e.split(c).join(f)}e=e.replace("{{images}}",g.getEntityImages());return e},getEntityImages:function(){var c="";switch(this.config.entityType){case"catalog_product":c=this.getProductImages();break;default:c=this.config.images.join("<br />");break}return c},getProductImages:function(){var c=[];b('[data-role="image"]').each(function(i,e){var d=b(e),h=d.find('[name*="file"]').val(),g=d.find('[name*="label"]').val(),f=d.find('[name*="disabled"]').val();if(f=="0"){c.push('<img src="'+h+'" alt="'+g+'" />')}});return c.join("<br /> ")},getElementValue:function(e){var c=e.prop("tagName").toLowerCase(),d="";switch(c){case"input":case"textarea":d=e.val();break;case"select":e.find("option:selected").each(function(){d+=(d!==""?", ":"")+b(this).text()});break}return d},getDescriptionValue:function(){return this.metaDescriptionInputElement.val()},setDescriptionValue:function(c){this.metaDescriptionInputElement.val(c).change();return this}});return b.maxServ.yoastSeo});